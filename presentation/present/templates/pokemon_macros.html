{%- set battle_data = {
  "rival": {
    "position": (320, 30),
    "poly": "134,258,158,263,168,263,184,265,197,262,211,255,215,249,212,225,221,193,216,182,217,156,214,143,218,118,219,98,212,79,198,58,177,39,155,35,141,35,113,42,92,51,83,64,79,75,79,95,81,118,92,140,110,152,128,172,136,186,135,205,128,225,129,242",
  },
  "advertiser-trainer": {
    "position": (80, 470),
    "poly": "142,247,152,256,200,262,214,254,214,232,211,223,213,208,209,189,205,179,208,167,218,153,222,144,222,128,224,119,230,97,222,72,213,57,199,42,180,33,161,40,144,55,136,68,131,81,120,84,106,74,89,65,82,66,75,75,68,99,68,113,82,124,103,126,132,131,141,137,149,143,149,157,141,174,139,191,138,216",
  },
  "scouts-trainer": {
    "position": (780, 640),
    "poly": "65,238,80,249,95,249,115,248,136,246,151,246,162,246,185,249,203,247,212,244,221,226,218,212,213,196,211,163,213,141,226,125,236,110,245,87,246,69,242,60,225,52,209,51,188,54,170,60,147,70,131,75,124,75,109,70,97,63,81,59,70,59,58,64,51,74,47,93,51,114,58,134,66,150,71,171,67,196,63,216",
  },
  "taxonomist-trainer": {
    "position": (400, 830),
    "poly": "115,254,129,260,147,266,168,262,182,256,188,248,193,227,198,197,199,172,200,152,199,125,198,100,196,79,188,53,176,43,157,35,136,39,122,51,114,67,117,90,112,105,102,128,98,149,97,171,101,208",
  },
  "bagon": {
    "position": (10, 210),
    "poly": "111,238,145,241,166,238,180,230,185,213,185,194,185,172,188,153,198,134,213,115,214,100,207,91,191,82,181,77,170,63,147,57,125,63,102,81,90,97,85,115,83,124,91,151,97,164,95,187,91,209,92,223,100,233",
  },
  "charmander": {
    "position": (80, 100),
    "poly": "78,141,81,157,105,200,119,213,145,217,174,217,193,204,208,183,220,153,220,126,215,109,202,99,187,95,180,100,165,83,143,80,118,86,100,99,88,113,82,125",
  },
  "charmeleon": {
    "position": (770, 160),
    "poly": "72,128,66,150,71,177,67,203,65,236,84,254,109,264,138,267,155,266,176,257,192,242,200,222,205,204,222,176,230,155,230,130,230,104,211,87,185,74,173,48,154,34,128,31,99,35,87,43,75,57,68,75,69,92,72,110",
  },
  "cofagrigus": {
    "position": (-10, 90),
    "poly": "69,282,85,288,103,283,120,274,131,262,129,248,118,229,144,221,154,224,156,232,152,252,161,267,167,288,177,296,200,287,226,244,233,216,227,196,210,182,189,175,177,178,180,161,186,137,202,114,205,101,204,86,223,73,228,49,218,28,202,17,177,11,158,23,157,38,165,57,159,62,137,57,106,70,117,40,101,18,84,6,74,3,57,8,45,21,40,41,44,67,56,75,75,71,75,89,71,102,73,114,81,128,90,137,104,173,98,183,78,203,78,242,74,258,68,270",
  },
  "cranidos": {
    "position": (460, 220),
    "poly": "99,146,102,164,114,192,130,213,148,223,171,219,185,207,189,185,199,160,198,128,193,99,184,82,174,77,149,86,146,102,127,115,110,128",
  },
  "dragonair": {
    "position": (690, 100),
    "poly": "42,180,40,196,41,211,46,226,60,239,79,247,96,247,111,242,124,240,139,246,164,247,184,246,196,244,205,233,212,216,214,198,211,177,209,157,221,147,246,141,262,126,260,105,253,82,233,61,209,53,186,51,164,57,156,79,159,99,162,144,161,158,150,178,122,193,103,197,83,186,73,172,53,169",
  },
  "dratini": {
    "position": (90, 80),
    "poly": "104,197,112,206,147,216,175,207,192,193,218,185,222,177,217,168,201,157,187,156,165,164,155,160,149,149,154,119,151,100,143,88,129,84,115,84,104,87,95,96,84,108,77,124,77,142,81,155,94,167,99,182",
  },
  "dusclops": {
    "position": (-30, 150),
    "poly": "84,251,100,257,149,253,158,254,198,253,213,237,221,216,226,181,218,166,214,153,216,145,239,125,243,112,236,95,223,93,209,100,197,105,187,107,172,78,199,77,218,48,204,40,188,42,173,45,162,47,143,44,125,47,109,57,111,75,110,86,99,97,86,110,73,120,63,133,57,146,52,160,58,177,71,185,91,192,82,210,81,231",
  },
  "duskull": {
    "position": (730, 80),
    "poly": "90,196,100,198,114,196,122,195,135,204,144,210,157,210,181,203,192,201,203,201,214,204,219,190,214,177,207,169,197,166,196,142,192,129,180,116,166,108,156,104,138,90,127,88,107,96,104,108,100,121,86,138,80,148,82,171",
  },
  "kingler": {
    "position": (-60, 150),
    "poly": "82,274,92,268,115,243,129,236,148,230,174,230,187,235,196,257,202,269,222,269,250,253,253,238,252,230,237,209,219,200,240,182,253,171,255,156,255,136,252,126,250,111,248,78,241,53,226,32,209,23,189,25,174,38,166,53,162,70,167,88,177,105,160,103,144,103,126,109,112,119,105,120,97,114,95,104,90,92,80,82,64,79,55,79,44,91,39,106,38,121,42,142,55,160,65,178,65,188,62,198,57,210,49,234,50,253,57,267,70,271",
  },
  "krabby": {
    "position": (700, 190),
    "poly": "92,177,82,188,82,204,100,215,111,217,130,209,165,205,177,213,183,221,203,218,209,208,208,199,204,188,203,177,215,155,222,143,224,121,220,106,207,92,194,89,177,98,160,106,152,107,138,102,124,89,116,84,101,78,88,81,80,95,75,107,79,130,88,150,93,164",
  },
  "lycanroc": {
    "position": (-50, 160),
    "poly": "77,255,92,250,117,232,132,233,147,241,157,244,175,245,191,233,212,228,227,232,240,237,250,234,257,228,259,208,262,185,281,162,280,137,278,118,273,106,276,82,264,59,251,47,232,42,223,40,207,43,195,47,190,64,181,77,166,85,149,89,129,93,107,91,90,93,73,94,58,97,46,103,38,113,31,130,24,147,17,169,16,180,25,212,32,221,39,231,46,242,61,249",
  },
  "meowth": {
    "position": (200, 100),
    "poly": "85,168,99,190,114,205,121,212,143,220,168,215,181,210,203,183,213,158,214,148,210,132,200,112,182,93,170,80,161,78,121,84,100,107,87,121,83,143",
  },
  "persian": {
    "position": (600, 100),
    "poly": "92,178,98,198,107,224,117,230,140,233,166,236,204,238,221,235,243,224,249,212,252,196,250,182,254,162,265,140,266,115,258,88,240,72,224,68,207,66,198,72,185,72,157,71,128,68,106,66,85,62,62,66,50,70,38,83,33,100,31,128,36,140,58,152,76,162",
  },
  "ponyta": {
    "position": (220, 190),
    "poly": "104,219,115,228,132,228,151,228,170,226,186,222,193,215,197,200,202,184,209,166,218,152,233,132,231,113,225,105,213,109,202,112,186,118,166,127,150,126,142,103,134,83,123,74,108,71,100,73,71,98,64,111,72,135,87,143,101,156,106,174,104,189,102,203",
  },
  "rampardos": {
    "position": (10, -10),
    "poly": "69,279,93,290,110,294,130,293,147,286,165,272,185,250,196,238,220,222,230,215,243,196,252,171,246,158,233,149,217,153,207,153,181,139,175,126,169,111,169,94,174,73,172,55,160,41,143,30,134,27,106,8,92,5,75,16,61,46,50,80,44,116,46,135,54,173,56,193,54,212,57,245",
  },
  "rapidash": {
    "position": (520, -20),
    "poly": "71,251,91,258,110,261,127,261,156,261,186,261,215,263,223,249,223,235,227,218,227,188,222,156,218,140,238,134,256,124,267,104,262,75,252,59,238,43,218,38,199,43,177,37,154,36,132,38,120,47,118,65,109,81,99,85,75,91,50,101,39,115,32,140,34,157,37,172,50,190,59,223",
  },
  "raticate": {
    "position": (660, -40),
    "poly": "123,51,106,41,94,40,77,55,65,70,54,90,44,118,44,137,45,160,55,182,79,213,103,241,129,257,158,260,186,258,210,252,223,245,238,232,247,207,254,178,255,152,252,131,251,105,243,81,232,63,212,55,197,56,175,59,156,59,139,57",
  },
  "rattata": {
    "position": (-10, 100),
    "poly": "116,211,139,214,165,217,179,217,202,210,213,207,219,191,210,174,203,154,204,133,201,114,193,92,179,83,162,87,153,109,144,116,112,122,97,125,86,130,81,145,82,163,94,186",
  },
  "rockruff": {
    "position": (760, 150),
    "poly": "95,211,116,219,129,219,147,222,173,222,198,211,202,202,204,179,204,160,210,145,216,121,203,102,191,91,176,82,147,75,117,78,93,86,89,98,86,122,83,147,86,179",
  },
  "shelgon": {
    "position": (620, 130),
    "poly": "74,248,88,246,109,249,134,250,150,254,166,256,204,250,219,248,238,231,238,209,238,182,236,156,238,125,232,107,221,86,206,71,187,58,161,44,149,41,131,46,110,51,93,61,82,74,71,93,62,117,57,139,59,179,61,221,66,240",
  },
  "squirtle": {
    "position": (500, 60),
    "poly": "93,215,121,227,139,227,167,224,193,222,211,205,217,185,224,163,229,137,230,119,227,99,219,87,200,76,186,71,166,70,152,73,124,94,103,112,87,126,73,137,64,154,67,162,68,173,83,200",
  },
  "wartortle": {
    "position": (250, 250),
    "poly": "95,257,111,268,139,271,177,266,200,256,207,244,208,233,208,218,216,206,234,197,242,191,249,176,247,156,240,133,230,114,220,106,207,97,210,63,206,41,193,32,183,32,166,38,154,39,139,30,127,30,106,37,99,45,91,60,87,68,79,79,66,88,54,98,50,119,50,132,59,145,77,160,94,182,101,198,99,221,95,240",
  },
  "yamask": {
    "position": (640, 180),
    "poly": "132,226,143,227,154,223,163,214,176,196,184,178,194,167,206,164,225,160,235,149,238,131,231,117,221,106,204,103,181,101,169,84,159,78,133,70,122,75,112,81,102,92,95,98,86,103,73,114,61,129,63,141,71,157,89,168,104,184,115,205",
  },
} -%}

{# random-ish, but predetermined #}
{%- set tape_data = (
  (6, 5),
  (5, 3),
  (2, 6),
  (1, 5),
  (3, 1),
  (2, 6),
  (4, 5),
  (3, 2),
  (1, 6),
  (2, 5),
  (1, 3),
  (4, 6),
  (6, 4),
) -%}

{% macro generate_tape(stage_index) %}
  {%- set data = tape_data[stage_index-1] -%}
  <img class="tape tape-L" {{img_src_for('rounds/pokemon/images/tape/' + data[0]|string + '.png')}}>
  <img class="tape tape-R" {{img_src_for('rounds/pokemon/images/tape/' + data[1]|string + '.png')}}>
{% endmacro %}

{% macro generate_puzzle_asset(type, index) %}
  {%- set puzzle_link_action = 'full_puzzle' if session.usertype == 'writingteam' else 'puzzle' -%}
  {%- set puzzle_id = 'pokemon-supermeta' if type=='supermeta' else ('pokemon-' + type + '-' + index|string) -%}
  {%- if puzzle_id in puzzle_visibilities -%}
    {%- set status = puzzle_visibilities[puzzle_id].status -%}
    {%- set answer = puzzle_visibilities[puzzle_id].solvedAnswers|join(', ') if status=='SOLVED' else none -%}
    {%- set props = puzzle_properties[puzzle_id].get('puzzleProperties', {}) -%}
    {%- set link_puzzle_id = props.get('DisplayIdProperty', {}).get('displayId', puzzle_id) -%}
    {%- set display_name = props.get('DisplayNameProperty', {}).get('displayName', puzzle_id) -%}
    {%- set symbol = props.get('SymbolProperty', {}).get('symbol', none) -%}
    
    {%- set data = battle_data[symbol] -%}
    {%- set style = 'left:' + data.position[0]|string + 'px;top:' + data.position[1]|string + 'px;' -%}
    {%- set link = url_for(puzzle_link_action, puzzle_id=link_puzzle_id) -%}
    
    {%- if status in ['UNLOCKED','SOLVED'] -%}
      {%- set map_name = 'pokemon-battle-map-' + 'R' if type=='supermeta' else ('T'+index|string) if type=='meta' else ('P'+index|string+('B' if type=='evolved' else '')) -%}
      {{- generate_icon_helper(symbol, status, class="battle", style=style, map=map_name) }}
      <map name="{{map_name}}">
        <area href="{{ link }}"
          shape="poly"
          coords="{{ data.poly }}"
          data-toggle="tooltip"
          data-placement="track"
          title="{{display_name}}"
          {% if answer is not none %} data-answer="{{answer}}" {% endif %}
        />
      </map>
    {%- endif -%}
  {%- endif %}
{% endmacro %}

{% macro generate_icon_helper(symbol, status, class=none, style=none, map=none) %}
  <img class="symbol {{ status|lower }} {%- if class %} {{class}}{%- endif %}" {%- if style %} style="{{style}}" {%- endif %} {{img_src_for('rounds/pokemon/images/icons/' + symbol + '.png')}} {%- if map %} usemap="#{{ map }}" {%- endif -%}"/>
{% endmacro %}

{% macro generate_puzzle_page_icon(puzzle) %}
  {%- set symbol = puzzle.puzzleProperties.get('SymbolProperty', {}).get('symbol', none) -%}
  {%- set status_class = 'solved' if site_mode=='solution' else puzzle_visibility.status -%}
  {{ generate_icon_helper(symbol, status_class) }}
{% endmacro %}

{% macro generate_puzzle_styles(puzzle) %}
  <link href="https://fonts.googleapis.com/css?family=Pangolin" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="{{ asset_url_for('rounds/pokemon/styles/icons.css') }}"/>
{% endmacro %}

{% macro generate_meta_styles() %}
  <style>
    .puzzle-content .pokemon-header {
      font-size: 18px;
      margin-bottom: 1em;
    }

    .puzzle-content .pokemon {
      display: inline-block;
      position: relative;
    }

    .puzzle-content .pokemon-team {
      margin-left: 80px;
    }

    .puzzle-content .pokemon-team img.symbol {
      position: absolute;
      bottom: 0;
      left: 0;
    }

    .puzzle-content .pokemon-team img {
      width: 115px;
    }

    .puzzle-content .line img {
      width: 100%;
    }
  </style>
{% endmacro %}

{% macro generate_puzzle_feeders() %}
  <hr>
  <div class="pokemon-header">Your Pokémon Team so far:</div>

  {% if feeders_solved|length == 0 %}
    You haven’t caught any Pokémon on this team yet! Make sure to
    check back later when you’ve caught some more.</p>
  {% endif %}
  <div class="pokemon-team">
    {% for feeder in feeders_solved %}
      <div class="pokemon">
        <img class="openingball" {{ img_src_for('rounds/pokemon/images/party/openingball.png') }}>
        {{ pokemon_macros.generate_icon_helper(feeder_properties[feeder].puzzleProperties.SymbolProperty.symbol, 'solved') }}
      </div>
    {% endfor %}
    {% for i in range(feeder_count - feeders_solved|length) %}
      <div class="pokemon">
        <img class="pokeball" {{ img_src_for('rounds/pokemon/images/party/closedball.png') }}>
      </div>
    {% endfor %}
  </div>
  <div class="line">
    <img {{ img_src_for('rounds/pokemon/images/party/line.png') }}>
  </div>
{% endmacro %}
